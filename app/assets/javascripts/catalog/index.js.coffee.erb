panel_class = 'inline-form-panel'
original_value_key = panel_class + '_original_value'

$ ->
  $(window).resize set_dimensions
  set_dimensions()
  $('.history_item').history_item_form()
  setup_testing_or_development()

setup_testing_or_development = ->
  if AntCat.testing
    $('.icon.edit').show()
  <%#else%>
    <%#if AntCat.environment is 'development'%>
      <%#$('.icon.edit').click()%>

#--------------------------------------------------
$.fn.history_item_form = ->
  this.each -> new AntCat.HistoryItemForm $(this)

class AntCat.HistoryItemForm
  constructor: ($element) ->
    @spinner_path = "<%= asset_path 'ui-anim_basic_16x16.gif' %>"
    (new Image()).src = @spinner_path
    @initialize $element
    return @

  initialize: ($element) =>
    @element = $element
    @element_class = 'history_item'
    @element
      .addClass(@element_class)
      .mouseenter(=> @element.find('.icon').show() unless @is_editing())
      .mouseleave(=> @element.find('.icon').hide())
      .find('.icon.edit').click @edit
    @element.find('.icon').hide() unless AntCat.testing

  @is_editing: -> $(".#{@element_class} div.form").is ':visible'
  is_editing: => @element.find('div.form') is ':visible'

  show: =>
    @save_form_values()
    @show_form()

  show_form: =>
    @element.find('div.display').hide()
    $('.icon').hide() unless AntCat.testing
    @element.find('div.form').show()
    @resize_edit_box()
    @setup_form()
    @element.find('.taxt_edit_box').first().focus()

  setup_form: =>
    self = @
    @element.find('form')
      .find('.submit')
        .button()
        .click(-> self.submit_form this )
        .end()
      .find('.cancel')
        .button()
        .click(-> self.cancel_form this )
        .end()
      .find('textarea')
        .taxt_edit_box()

  save_form_values: =>
    $taxt_edit_box = @element.find 'textarea'
    $taxt_edit_box.data original_value_key, $taxt_edit_box.val()

  resize_edit_box: =>
    # make the textarea of the form the same height as the item it's editing
    display_height = @element.find('div.display').height()
    @element.find('.taxt_edit_box').height display_height + 30

  submit_form: (button) =>
    $form = $(button).closest('form')
    @start_spinning()
    $form.ajaxSubmit
      success: @update_form
      error: @handle_error
      dataType: 'json'
    false

  update_form: (data, statusText, xhr, $form) =>
    @stop_spinning()
    panel_selector = '#item_' + (if data.isNew then "" else data.id)
    $panel = $ panel_selector
    if not data.success
      @show_error_messages $form, data.content
      return
    $panel.replaceWith data.content
    @initialize $(panel_selector)

  cancel_form: (button) =>
    $form = $(button).closest('form')
    @clear_error_messages()
    unless @element.attr('id') is 'item_'
      id = @element.attr('id')
      @restore_form_values()
      $panel = $('#' + id)
      $panel.find('div.form').hide()
      $panel.find('div.display').show()
    false

  restore_form_values: =>
    $taxt_edit_box = @element.find('textarea')
    $taxt_edit_box.val $taxt_edit_box.data original_value_key

  handle_error: (jq_xhr, text_status, error_thrown) =>
    @stop_spinning()
    alert "Oh, shoot. It looks like a bug prevented this item from being saved.\n\nPlease report this situation to Mark Wilden (mark@mwilden.com) and we'll fix it.\n\n#{error_thrown}" unless AntCat.testing

  start_spinning: =>
    @element.find(':button')
      .disable()
      .parent().spinner position: 'left', leftOffset: 1, img: @spinner_path

  stop_spinning: =>
    @element.find('.spinner')
      .enable()
      .spinner 'remove'

  show_error_messages: ($form, html) ->
    clear_error_messages()
    $form.prepend $(html).find 'ul.error_messages'

  clear_error_messages: =>
    @element.find('ul.error_messages').remove()

  edit: =>
    return false if @is_editing()
    @show()
    set_dimensions()
    false

#--------------------------------------------------

set_dimensions = ->
  set_height()
  set_width()

set_height = ->
  if AntCat.HistoryItemForm.is_editing()
    $("#page").height('auto')
    $(".antcat_taxon").height('auto')
  else
    $("#page").height('100%')
    $(".antcat_taxon").height('20em')

  height = $('#page').height() -
    $('#site_header').height() -
    $('#page_header').height() - 2 -
    $('#page_notice').height() -
    $('#page_alert').height() -
    $('#search_results').height() - 3 - 2 - 2 -
    $('#taxon_key').height() - 2 -
    $('#site_footer').height() - 8

  if AntCat.HistoryItemForm.is_editing()
    $("#catalog").height('auto')
    $("#catalog .index").height('auto')
  else
    $("#catalog").height(height)
    $("#catalog .index").height(height - $("#catalog .content").height())

set_width = ->
  $("#catalog .content").width($('#page').width())
